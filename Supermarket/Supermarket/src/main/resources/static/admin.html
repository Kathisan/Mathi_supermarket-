<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mathi's Grocery - Online Store - Admin Dashboard</title>
    <!-- Bootstrap CSS -->
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
            rel="stylesheet"
    />
    <style>
        body {
          background-color: #f8f9fa;
          font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
          margin: 0;
          padding: 0;
        }

        .header-section {
          background: #4caf50;
          color: white;
          padding: 20px 30px;
          border-bottom: 1px solid #e9ecef;
        }

        .dashboard-title {
          font-size: 2rem;
          font-weight: 600;
          margin: 0;
        }

        .card {
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          transition: box-shadow 0.2s ease;
        }

        .card:hover {
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .card-header {
          background: #f8f9fa;
          color: #343a40;
          border-radius: 8px 8px 0 0 !important;
          border-bottom: 1px solid #e0e0e0;
          font-weight: 600;
          padding: 15px 20px;
        }

        .alert-card .card-header {
          background: #fff5f5;
          color: #dc3545;
        }

        .products-card .card-header {
          background: #f0f9ff;
          color: #0ea5e9;
        }

        .form-control,
        .form-select {
          border-radius: 6px;
          border: 1px solid #ced4da;
          padding: 10px 12px;
          transition: border-color 0.2s ease;
        }

        .form-control:focus,
        .form-select:focus {
          border-color: #4caf50;
          box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }

        .btn {
          border-radius: 6px;
          padding: 10px 20px;
          font-weight: 500;
          transition: background-color 0.2s ease;
        }

        .btn-success {
          background-color: #4caf50;
          border-color: #4caf50;
        }

        .btn-success:hover {
          background-color: #45a049;
          border-color: #45a049;
        }

        .btn-danger {
          background-color: #dc3545;
          border-color: #dc3545;
        }

        .table {
          border-radius: 6px;
          overflow: hidden;
        }

        .table thead th {
          background-color: #f8f9fa;
          color: #495057;
          border: none;
          font-weight: 600;
          padding: 12px 15px;
        }

        .table tbody tr:hover {
          background-color: #f8f9fa;
        }

        .table tbody td {
          padding: 12px 15px;
          border-color: #e9ecef;
          vertical-align: middle;
        }

        .alert-item {
          background: #fff;
          border: 1px solid #e0e0e0;
          border-left: 3px solid #dc3545;
          border-radius: 6px;
          margin-bottom: 8px;
          padding: 12px 15px;
        }

        .stats-badge {
          background-color: #007bff;
          color: white;
          border-radius: 15px;
          padding: 4px 12px;
          font-weight: 500;
          font-size: 0.85rem;
        }

        .icon-wrapper {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 32px;
          height: 32px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 6px;
          margin-right: 8px;
        }

        .product-image {
          width: 60px;
          height: 60px;
          object-fit: cover;
          border-radius: 6px;
        }
    </style>
</head>
<body>
<div class="main-container">
    <!-- Header Section -->
    <div class="header-section">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="dashboard-title">
                    <div class="icon-wrapper d-inline-flex">
                        <i class="bi bi-shop"></i>
                    </div>
                    Mathis Grocery Supermarket Admin
                </h1>
                <p class="mb-0 fs-5 opacity-90">Manage your supermarket</p>
            </div>
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <a
                            href="/orders.html"
                            class="btn btn-info me-2 position-relative"
                    >
                        <i class="bi bi-box-seam-fill me-2"></i>
                        View Orders
                        <span
                                id="new-order-notification"
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                style="display: none"
                        >
                  0
                </span>
                    </a>
                    <a href="/user-management.html" class="btn btn-light">
                        <i class="bi bi-people-fill me-2"></i>
                        Manage Users
                    </a>
                </div>
                <button class="btn btn-danger btn-lg" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-2"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>

    <div class="container-fluid p-4">
        <!-- Add Brand / Category Button -->
        <div class="d-flex justify-content-end mb-3">
            <a href="/admin-add-brand-category.html" class="btn btn-secondary">
                <i class="bi bi-plus-circle me-1"></i>
                Add Brand / Category
            </a>
        </div>

        <!-- Top Row - Add Product and Alerts -->
        <div class="row g-4 mb-4">
            <!-- Add New Product Card -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-plus-circle me-2"></i>
                            Add New Product
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="productForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Product Name</label>
                                    <input
                                            type="text"
                                            class="form-control"
                                            id="name"
                                            placeholder="Enter product name"
                                            required
                                    />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Price (£)</label>
                                    <input
                                            type="number"
                                            class="form-control"
                                            id="price"
                                            placeholder="0.00"
                                            step="0.01"
                                            min="0"
                                            required
                                    />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Quantity</label>
                                    <input
                                            type="number"
                                            class="form-control"
                                            id="quantity"
                                            placeholder="0"
                                            min="0"
                                            required
                                    />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Unit</label> <!-- CHANGED/ADDED -->
                                    <select class="form-select" id="unit" required> <!-- CHANGED/ADDED -->
                                        <option value="">Select unit</option> <!-- CHANGED/ADDED -->
                                        <option value="kg">kg</option> <!-- CHANGED/ADDED -->
                                        <option value="ltr">ltr</option> <!-- CHANGED/ADDED -->
                                        <option value="pcs">pcs</option> <!-- CHANGED/ADDED -->
                                    </select> <!-- CHANGED/ADDED -->
                                </div>


                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Brand</label>
                                    <select class="form-select" id="brand" required>
                                        <option value="">Select brand</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Category</label>
                                    <select class="form-select" id="category" required>
                                        <option value="">Select category</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Expiry Date</label>
                                    <input
                                            type="date"
                                            class="form-control"
                                            id="expiryDate"
                                            required
                                    />
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-semibold">Product Image</label>
                                    <input
                                            type="file"
                                            class="form-control"
                                            id="image"
                                            accept="image/*"
                                            required
                                    />
                                </div>

                            </div>
                            <div class="d-grid mt-4">
                                <button
                                        type="button"
                                        class="btn btn-success btn-lg"
                                        onclick="addProduct()"
                                >
                                    <i class="bi bi-plus-circle me-2"></i>
                                    Add Product
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Alerts Card -->
            <div class="col-lg-6">
                <div class="card h-100 alert-card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Alerts & Notifications
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h5 class="text-danger mb-3">
                                Low Stock Products
                                <span class="stats-badge" id="low-stock-count">0</span>
                            </h5>
                            <div id="low-stock-list" class="alert-list">
                                <div class="text-muted">No low stock alerts</div>
                            </div>
                        </div>
                        <div>
                            <h5 class="text-warning mb-3">
                                Expiring Soon
                                <span class="stats-badge" id="expiry-count">0</span>
                            </h5>
                            <div id="expiring-soon-list" class="alert-list">
                                <div class="text-muted">No expiring products</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Table Card -->
        <div class="card products-card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-grid-3x3-gap me-2"></i>
                        All Products in Stock
                    </h4>
                    <span class="stats-badge" id="total-products">0 Products</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="products-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Quantity</th>

                            <th>Unit</th>
                            <th>Total (£)</th>

                            <th>Expiry Date</th>
                            <th>Status</th>
                            <th><i class="bi bi-gear me-1"></i>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Product rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Product Modal -->
<div class="modal fade" id="updateProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Product</h5>
                <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                ></button>
            </div>
            <div class="modal-body">
                <form id="updateProductForm">
                    <input type="hidden" id="updateProductId" />
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Product Name</label>
                            <input
                                    type="text"
                                    class="form-control"
                                    id="updateName"
                                    required
                            />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price (£)</label>
                            <input
                                    type="number"
                                    class="form-control"
                                    id="updatePrice"
                                    required
                            />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quantity</label>
                            <input
                                    type="number"
                                    class="form-control"
                                    id="updateQuantity"
                                    required
                            />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Unit</label> <!-- CHANGED/ADDED -->
                            <select class="form-select" id="updateUnit" required> <!-- CHANGED/ADDED -->
                                <option value="">Select unit</option> <!-- CHANGED/ADDED -->
                                <option value="kg">kg</option> <!-- CHANGED/ADDED -->
                                <option value="ltr">ltr</option> <!-- CHANGED/ADDED -->
                                <option value="pcs">pcs</option> <!-- CHANGED/ADDED -->
                            </select> <!-- CHANGED/ADDED -->
                        </div>


                        <div class="col-md-6">
                            <label class="form-label">Expiry Date</label>
                            <input
                                    type="date"
                                    class="form-control"
                                    id="updateExpiryDate"
                                    required
                            />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                >
                    Close
                </button>
                <button
                        type="button"
                        class="btn btn-primary"
                        onclick="updateProduct()"
                >
                    Save changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
    // Check admin authentication
    if (sessionStorage.getItem("isAdminLoggedIn") !== "true") {
      window.location.href = "/login.html";
    }

    function showToast(message, type = "success") {
    }

    function getStatusBadge(quantity, expiryDate) {
      const today = new Date();
      const expiry = new Date(expiryDate);
      const daysUntilExpiry = Math.ceil(
        (expiry - today) / (1000 * 60 * 60 * 24)
      );

      if (quantity < 10) {
        return '<span class="badge bg-danger">Low Stock</span>';
      } else if (daysUntilExpiry <= 30) {
        return '<span class="badge bg-warning">Expiring</span>';
      } else {
        return '<span class="badge bg-success">Good</span>';
      }
    }

    async function fetchAllProducts() {
      try {
        const response = await fetch("/api/products");
        const products = await response.json();
        const tableBody = document.querySelector("#products-table tbody");
        tableBody.innerHTML = "";

        products.forEach((p) => {
          const statusBadge = getStatusBadge(p.quantity, p.expiryDate);
            const totalPrice = (p.price * p.quantity).toFixed(2); // CHANGED/ADDED
          tableBody.innerHTML += `
                      <tr>
                          <td><strong>#${p.id}</strong></td>
                          <td><img src="${p.imageUrl}" alt="${
            p.name
          }" class="product-image"></td>
                          <td>${p.name}</td>
                          <td>£ ${parseFloat(p.price).toFixed(2)}</td>
                          <td>${p.quantity} </td>
                          <td>${p.unit}</td> <!-- display unit -->
                          <td>£ ${totalPrice}</td> <!-- display total price -->
                          <td>${new Date(p.expiryDate).toLocaleDateString()}</td>
                          <td>${statusBadge}</td>
                          <td>
  <button class="btn btn-sm btn-primary" onclick="openUpdateModal(${
    p.id
  })"><i class="bi bi-pencil-square"></i></button>
  <button class="btn btn-sm btn-danger" onclick="deleteProduct(${
    p.id
  })"><i class="bi bi-trash"></i></button>
</td>
                      </tr>
                  `;
        });
        document.getElementById(
          "total-products"
        ).textContent = `${products.length} Products`;
      } catch (error) {
        console.error("Error fetching products:", error);
      }
    }

    async function fetchLowStockAlerts() {
      try {
        const response = await fetch("/api/products/alerts/lowstock");
        const products = await response.json();
        const list = document.getElementById("low-stock-list");

        list.innerHTML =
          products.length === 0
            ? '<div class="text-muted">No low stock alerts</div>'
            : products
                .map(
                  (p) =>
                    `<div class="alert-item"><strong>${p.name}</strong> (${p.quantity} units left)</div>`
                )
                .join("");
        document.getElementById("low-stock-count").textContent =
          products.length;
      } catch (error) {
        console.error("Error fetching low stock alerts:", error);
      }
    }

    async function fetchExpiryAlerts() {
      try {
        const response = await fetch("/api/products/alerts/expiringsoon");
        const products = await response.json();
        const list = document.getElementById("expiring-soon-list");

        list.innerHTML =
          products.length === 0
            ? '<div class="text-muted">No expiring products</div>'
            : products
                .map(
                  (p) =>
                    `<div class="alert-item"><strong>${
                      p.name
                    }</strong> (Expires: ${new Date(
                      p.expiryDate
                    ).toLocaleDateString()})</div>`
                )
                .join("");
        document.getElementById("expiry-count").textContent = products.length;
      } catch (error) {
        console.error("Error fetching expiry alerts:", error);
      }
    }

    async function addProduct() {
      try {
        const formData = new FormData();
        formData.append("name", document.getElementById("name").value.trim());
        formData.append(
          "price",
          parseFloat(document.getElementById("price").value)
        );
        formData.append(
          "quantity",
          parseInt(document.getElementById("quantity").value)
        );

        formData.append("unit", document.getElementById("unit").value);// CHANGED/ADDE
          formData.append("brandId", document.getElementById("brand").value);
          formData.append("categoryId", document.getElementById("category").value);



          formData.append(
          "expiryDate",
          document.getElementById("expiryDate").value
        );
        formData.append("image", document.getElementById("image").files[0]);

        if (
          !formData.get("name") ||
          !formData.get("price") ||
          !formData.get("quantity") ||

            !formData.get("unit") ||

          !formData.get("expiryDate") ||
          !formData.get("image")
        ) {
          alert("Please fill all fields, including the image and unit.");
          return;
        }

        const response = await fetch("/api/products/add", {
          method: "POST",
          body: formData,
        });

        if (response.ok) {
          alert("Product added successfully!");
          document.getElementById("productForm").reset();
          loadAllData();
        } else {
          alert("Error adding product.");
        }
      } catch (error) {
        console.error("Error adding product:", error);
        alert("An error occurred. Please check the console.");
      }
    }

    async function fetchNewOrderNotification() {
      const response = await fetch("/api/orders/count/new");
      const count = await response.json();
      const notificationBadge = document.getElementById(
        "new-order-notification"
      );

      if (count > 0) {
        notificationBadge.innerText = count;
        notificationBadge.style.display = "block";
      } else {
        notificationBadge.style.display = "none";
      }
    }

    function loadAllData() {
      fetchAllProducts();
      fetchLowStockAlerts();
      fetchExpiryAlerts();
      fetchNewOrderNotification();
    }

    function logout() {
      sessionStorage.removeItem("isAdminLoggedIn");
      window.location.href = "/login.html";
    }

    document.getElementById("expiryDate").min = new Date()
      .toISOString()
      .split("T")[0];
    // Function to delete a product
    async function deleteProduct(id) {
      if (confirm("Are you sure you want to delete this product?")) {
        try {
          const response = await fetch(`/api/products/${id}`, {
            method: "DELETE",
          });
          if (response.ok) {
            showToast("Product deleted successfully!", "success");
            loadAllData();
          } else {
            showToast("Error deleting product", "danger");
          }
        } catch (error) {
          console.error("Error deleting product:", error);
          showToast("Error deleting product", "danger");
        }
      }
    }

    // Function to open the update modal and fill it with product data
    async function openUpdateModal(id) {
      try {
        const response = await fetch(`/api/products/${id}`);
        const product = await response.json();

        document.getElementById("updateProductId").value = product.id;
        document.getElementById("updateName").value = product.name;
        document.getElementById("updatePrice").value = product.price;
        document.getElementById("updateQuantity").value = product.quantity;
          document.getElementById("updateUnit").value = product.unit; // CHANGED/ADDED
        document.getElementById("updateExpiryDate").value =
          product.expiryDate;

        const modal = new bootstrap.Modal(
          document.getElementById("updateProductModal")
        );
        modal.show();
      } catch (error) {
        console.error("Error fetching product details:", error);
        showToast("Could not load product data for update", "danger");
      }
    }

    // Function to send updated data to the backend
    async function updateProduct() {
      const id = document.getElementById("updateProductId").value;
      const updatedProduct = {
        name: document.getElementById("updateName").value,
        price: parseFloat(document.getElementById("updatePrice").value),
        quantity: parseInt(document.getElementById("updateQuantity").value),
          unit: document.getElementById("updateUnit").value, // CHANGED/ADDED
        expiryDate: document.getElementById("updateExpiryDate").value,
      };

      try {
        const response = await fetch(`/api/products/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedProduct),
        });

        if (response.ok) {
          showToast("Product updated successfully!", "success");
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("updateProductModal")
          );
          modal.hide();
          loadAllData();
        } else {
          showToast("Error updating product", "danger");
        }
      } catch (error) {
        console.error("Error updating product:", error);
        showToast("Error updating product", "danger");
      }
    }

    async function loadBrandsAndCategories() {
        try {
            const [brandsRes, categoriesRes] = await Promise.all([
                fetch("/api/brands"),
                fetch("/api/categories"),
            ]);

            const brands = await brandsRes.json();
            const categories = await categoriesRes.json();

            const brandSelect = document.getElementById("brand");
            const categorySelect = document.getElementById("category");

            brandSelect.innerHTML = '<option value="">Select brand</option>';
            categorySelect.innerHTML = '<option value="">Select category</option>';

            brands.forEach(b => {
                brandSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
            });
            categories.forEach(c => {
                categorySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });

        } catch (error) {
            console.error("Error loading brands/categories:", error);
        }
    }


    window.onload = () => {
        loadAllData();          // existing: loads products, alerts, notifications
        loadBrandsAndCategories();  // new: loads brand & category dropdowns
    };

</script>
</body>
</html>
